# =============================================================================
# Tenant Blueprint — copied per tenant by the Provisioning API
# Variables like ${TENANT_NAME}, ${DOMAIN}, ${THEME} are substituted
# from the .env file rendered by docker_manager.py at provision time.
# =============================================================================
#
# NOTE ON IMAGES:
# - storefront: nginx:alpine serving a generated themed HTML (ready now)
# - medusa:     nginx:alpine serving a placeholder admin UI (ready now)
#
# To upgrade to real images, change:
#   medusa:    image: medusajs/medusa:latest
#   storefront: image: your-registry/storefront:${THEME}
# =============================================================================

services:

  # ---------------------------------------------------------------------------
  # MedusaJS Backend Placeholder
  # Using nginx:alpine with a generated admin.html until a real Medusa image
  # is available (avoids Docker Hub rate limits / private registry requirement).
  # ---------------------------------------------------------------------------
  medusa:
    image: nginx:alpine
    container_name: medusa-${TENANT_NAME}
    restart: always
    volumes:
      - ./admin.html:/usr/share/nginx/html/index.html:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.admin-${TENANT_NAME}.rule=Host(`admin.${TENANT_NAME}.${DOMAIN}`)"
      - "traefik.http.routers.admin-${TENANT_NAME}.entrypoints=web"
      - "traefik.http.services.admin-${TENANT_NAME}.loadbalancer.server.port=80"

  # ---------------------------------------------------------------------------
  # Storefront — nginx:alpine serving a generated themed HTML file
  # storefront.html is written by docker_manager.py at provision time.
  # ---------------------------------------------------------------------------
  storefront:
    image: nginx:alpine
    container_name: storefront-${TENANT_NAME}
    restart: always
    volumes:
      - ./storefront.html:/usr/share/nginx/html/index.html:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.store-${TENANT_NAME}.rule=Host(`${TENANT_NAME}.${DOMAIN}`)"
      - "traefik.http.routers.store-${TENANT_NAME}.entrypoints=web"
      - "traefik.http.services.store-${TENANT_NAME}.loadbalancer.server.port=80"

# All tenant containers join the shared Traefik network
networks:
  default:
    name: traefik_default
    external: true
