# This is the master blueprint that the API copies for each new tenant
# It defines how Medusa and the Storefront spin up for this specific store

services:
  # 1. MedusaJS Backend Container
  medusa:
    image: medusajs/medusa:latest # Or a custom built image with your logic
    container_name: medusa-${TENANT_NAME}
    restart: always
    environment:
      # Inject Postgres credentials provisioned by our API
      - DATABASE_URL=postgres://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/${DB_NAME}
      - JWT_SECRET=supersecret_${TENANT_NAME}
      - COOKIE_SECRET=cookiesecret_${TENANT_NAME}
      - REDIS_URL=redis://redis:6379 # Shared or per-tenant redis
      - STORE_CORS=http://${TENANT_NAME}.${DOMAIN}
      - ADMIN_CORS=http://admin.${TENANT_NAME}.${DOMAIN}
    labels:
      - "traefik.enable=true"
      # Route requests matching admin.storename.domain.com to this backend container
      - "traefik.http.routers.admin-${TENANT_NAME}.rule=Host(`admin.${TENANT_NAME}.${DOMAIN}`)"
      - "traefik.http.routers.admin-${TENANT_NAME}.entrypoints=web"
      # - "traefik.http.routers.admin-${TENANT_NAME}.tls=true"
      # - "traefik.http.routers.admin-${TENANT_NAME}.tls.certresolver=myresolver"

  # 2. Next.js Storefront Container
  storefront:
    # Use the selected theme image (e.g. my-registry/storefront:fashion or storefront:electronics)
    image: my-registry/storefront:${THEME} 
    container_name: storefront-${TENANT_NAME}
    restart: always
    environment:
      # Link storefront to this tenant's medusa backend API
      - NEXT_PUBLIC_MEDUSA_BACKEND_URL=http://medusa:9000
    labels:
      - "traefik.enable=true"
      # Route requests matching storename.domain.com to the storefront
      - "traefik.http.routers.store-${TENANT_NAME}.rule=Host(`${TENANT_NAME}.${DOMAIN}`)"
      - "traefik.http.routers.store-${TENANT_NAME}.entrypoints=web"
      # - "traefik.http.routers.store-${TENANT_NAME}.tls=true"
      # - "traefik.http.routers.store-${TENANT_NAME}.tls.certresolver=myresolver"

  # Optional but recommended for Medusa Job queue / caching
  redis:
    image: redis:alpine
    container_name: redis-${TENANT_NAME}
    restart: always
