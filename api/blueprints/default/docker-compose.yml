# =============================================================================
# Tenant Blueprint — copied per tenant by the Provisioning API
# Variables like ${TENANT_NAME}, ${DOMAIN}, ${THEME} are substituted
# from the .env file rendered by docker_manager.py at provision time.
# =============================================================================
#
# NOTE ON IMAGES:
# - storefront: nginx:alpine serving a generated themed HTML (ready now)
# - medusa:     nginx:alpine serving a placeholder admin UI (ready now)
#
# To upgrade to real images, change:
#   medusa:    image: medusajs/medusa:latest
#   storefront: image: your-registry/storefront:${THEME}
# =============================================================================

services:

  # ---------------------------------------------------------------------------
  # MedusaJS Backend
  # Uses the base image we compile once. Connects to isolated tenant DB on
  # shared-postgres, and an isolated Redis instance defined below.
  # ---------------------------------------------------------------------------
  medusa:
    image: my-registry/medusa-base:latest
    pull_policy: never   # Image is built locally on the host — never pull from external registry
    container_name: medusa-${TENANT_NAME}
    restart: always
    depends_on:
      - redis
    env_file:
      - .env
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.admin-${TENANT_NAME}.rule=Host(`admin.${TENANT_NAME}.${DOMAIN}`)"
      - "traefik.http.routers.admin-${TENANT_NAME}.entrypoints=web"
      - "traefik.http.services.admin-${TENANT_NAME}.loadbalancer.server.port=9000"

  # ---------------------------------------------------------------------------
  # Redis (Isolated per tenant)
  # Required by MedusaJS for sessions, queues, etc.
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: redis-${TENANT_NAME}
    restart: always

  # ---------------------------------------------------------------------------
  # Storefront — nginx:alpine serving a generated themed HTML file
  # storefront.html is written by docker_manager.py at provision time.
  # ---------------------------------------------------------------------------
  storefront:
    image: nginx:alpine
    container_name: storefront-${TENANT_NAME}
    restart: always
    volumes:
      - ./storefront.html:/usr/share/nginx/html/index.html:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.store-${TENANT_NAME}.rule=Host(`${TENANT_NAME}.${DOMAIN}`)"
      - "traefik.http.routers.store-${TENANT_NAME}.entrypoints=web"
      - "traefik.http.services.store-${TENANT_NAME}.loadbalancer.server.port=80"

# All tenant containers join the shared Traefik network
networks:
  default:
    name: traefik_default
    external: true
