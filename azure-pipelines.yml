trigger:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  - name: key_name
    value: your-aws-key # Override in Azure DevOps Library / Pipeline Variables (mark as secret)
  - name: domain_name
    value: example.com # Override in Azure DevOps Library / Pipeline Variables
  # DB_PASSWORD should be set as a SECRET variable in Azure DevOps — never in plain text here

steps:
  - task: TerraformInstaller@1
    displayName: "Install Terraform"
    inputs:
      terraformVersion: "latest"

  - task: TerraformTask@5
    displayName: "Terraform Init"
    inputs:
      provider: "aws"
      command: "init"
      workingDirectory: "$(System.DefaultWorkingDirectory)/terraform"
      backendServiceAWS: "aws-terraform-connection"
      backendAWSBucketName: "my-dashboard-s3"
      backendAWSKey: "infrastructure/terraform.tfstate"

  - task: TerraformTask@5
    displayName: "Terraform Validate"
    inputs:
      provider: "aws"
      command: "validate"
      workingDirectory: "$(System.DefaultWorkingDirectory)/terraform"

  - task: TerraformTask@5
    displayName: "Terraform Plan"
    inputs:
      provider: "aws"
      command: "plan"
      workingDirectory: "$(System.DefaultWorkingDirectory)/terraform"
      environmentServiceNameAWS: "aws-terraform-connection"
    env:
      TF_VAR_key_name: $(key_name)
      TF_VAR_domain_name: $(domain_name)
      TF_VAR_db_password: $(DB_PASSWORD) # Must be a secret pipeline variable

  - task: TerraformTask@5
    displayName: "Terraform Apply"
    inputs:
      provider: "aws"
      command: "apply"
      workingDirectory: "$(System.DefaultWorkingDirectory)/terraform"
      environmentServiceNameAWS: "aws-terraform-connection"
      # Fix: -auto-approve is required — without it, Terraform hangs waiting for stdin in CI
      commandOptions: "-auto-approve"
    env:
      TF_VAR_key_name: $(key_name)
      TF_VAR_domain_name: $(domain_name)
      TF_VAR_db_password: $(DB_PASSWORD)

  # Uncomment to enable destroy stage (add a manual approval gate in Azure DevOps!)
  # - task: TerraformTask@5
  #   displayName: "Terraform Destroy"
  #   inputs:
  #     provider: "aws"
  #     command: "destroy"
  #     workingDirectory: "$(System.DefaultWorkingDirectory)/terraform"
  #     environmentServiceNameAWS: "aws-terraform-connection"
  #     commandOptions: "-auto-approve"
  #   env:
  #     TF_VAR_key_name: $(key_name)
  #     TF_VAR_domain_name: $(domain_name)
  #     TF_VAR_db_password: $(DB_PASSWORD)
