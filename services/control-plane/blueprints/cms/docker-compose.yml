services:
  # ---------------------------------------------------------------------------
  # Directus CMS — standard headless CMS
  # ---------------------------------------------------------------------------
  directus:
    image: directus/directus:11.1
    container_name: directus-${TENANT_NAME}
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - "{{TENANT_NAME}}-cms-uploads:/directus/uploads"
      - "{{TENANT_NAME}}-cms-extensions:/directus/extensions"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.admin-${TENANT_NAME}.rule=Host(`admin.${TENANT_NAME}.${DOMAIN}`)"
      - "traefik.http.routers.admin-${TENANT_NAME}.entrypoints=web"
      - "traefik.http.services.admin-${TENANT_NAME}.loadbalancer.server.port=8055"
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1G

  # ---------------------------------------------------------------------------
  # Storefront — serves the custom HTML frontend
  # ---------------------------------------------------------------------------
  storefront:
    image: nginx:alpine
    container_name: storefront-${TENANT_NAME}
    restart: unless-stopped
    volumes:
      - ./storefront.html:/usr/share/nginx/html/index.html:ro
      - ./storefront-nginx.conf:/etc/nginx/nginx.conf:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.store-${TENANT_NAME}.rule=Host(`${TENANT_NAME}.${DOMAIN}`)"
      - "traefik.http.routers.store-${TENANT_NAME}.entrypoints=web"
      - "traefik.http.services.store-${TENANT_NAME}.loadbalancer.server.port=80"

# Persistent storage for CMS content
volumes:
  "{{TENANT_NAME}}-cms-uploads":
  "{{TENANT_NAME}}-cms-extensions":

# All tenant containers join the shared Traefik network
networks:
  default:
    name: traefik_default
    external: true
